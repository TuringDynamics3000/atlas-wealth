# ============================================================
# Atlas Wealth — Pre-Commit Governance (Authoritative)
# ============================================================

$ErrorActionPreference = "Stop"

# ------------------------------------------------------------
# Load staged files ONCE
# ------------------------------------------------------------
$ChangedFiles = git diff --cached --name-only

# ------------------------------------------------------------
# POLICY DRIFT GUARD (ALWAYS RUNS)
# ------------------------------------------------------------
$PolicyTouched   = $false
$RegistryTouched = $false
$BundleTouched   = $false

foreach ($f in $ChangedFiles) {
    if ($f -match '^policies/') { $PolicyTouched = $true }
    if ($f -eq 'policies/POLICY_REGISTRY.json') { $RegistryTouched = $true }
    if ($f -eq 'policies/POLICY_BUNDLE.sha256') { $BundleTouched = $true }
}

if ($PolicyTouched -and (-not ($RegistryTouched -and $BundleTouched))) {
    Write-Error @"
POLICY DRIFT BLOCKED:

You modified files under policies/ but did not recompute policy hashes.

Required in the same commit:
- policies/POLICY_REGISTRY.json
- policies/POLICY_BUNDLE.sha256

Run:
  .\18-Compute-Policy-Hashes.ps1
and recommit.
"@
}

# ------------------------------------------------------------
# FINAL_ADVICE DETECTION
# ------------------------------------------------------------
$FinalAdviceTouched = $false
$AdviceEventTouched = $false

foreach ($File in $ChangedFiles) {
    if ($File -match '^src/advice/final/') {
        $FinalAdviceTouched = $true
    }

    if (Test-Path $File) {
        if (Select-String -Path $File -Pattern 'AdviceFinalised' -Quiet) {
            $AdviceEventTouched = $true
        }
    }
}

# If NOT final advice, we are done
if (-not ($FinalAdviceTouched -or $AdviceEventTouched)) {
    exit 0
}

# ------------------------------------------------------------
# FINAL_ADVICE GOVERNANCE
# ------------------------------------------------------------
$CommitMsgFile = ".git/COMMIT_EDITMSG"
$CommitMsg = Get-Content $CommitMsgFile -Raw

if ($CommitMsg -notmatch 'FINAL_ADVICE:') {
    Write-Error "FINAL ADVICE BLOCKED: Missing FINAL_ADVICE declaration."
}

if ($CommitMsg -notmatch 'Evidence-Pack:\s*[a-f0-9\-]{36}') {
    Write-Error "FINAL ADVICE BLOCKED: Missing or invalid Evidence-Pack UUID."
}

if ($CommitMsg -notmatch 'Advice-Notepad:\s*[a-f0-9\-]{36}') {
    Write-Error "FINAL ADVICE BLOCKED: Missing or invalid Advice-Notepad UUID."
}

if ($CommitMsg -notmatch 'Policy-Bundle-Hash:\s*[a-f0-9]{64}') {
    Write-Error "FINAL ADVICE BLOCKED: Missing or invalid Policy-Bundle-Hash."
}

$EvidenceId = ($CommitMsg | Select-String 'Evidence-Pack:' | ForEach-Object {
    $_.ToString().Split(':')[1].Trim()
})

$NotepadId = ($CommitMsg | Select-String 'Advice-Notepad:' | ForEach-Object {
    $_.ToString().Split(':')[1].Trim()
})

$EvidencePath = "evidence/packs/$EvidenceId"
$NotepadPath  = "notepads/advice/$NotepadId.notepad.md"

if (-not (Test-Path $EvidencePath)) {
    Write-Error "FINAL ADVICE BLOCKED: Evidence Pack does not exist."
}

if (-not (Test-Path $NotepadPath)) {
    Write-Error "FINAL ADVICE BLOCKED: Advice Notepad does not exist."
}

if (-not (Test-Path "$NotepadPath.sha256")) {
    Write-Error "FINAL ADVICE BLOCKED: Advice Notepad hash missing."
}

exit 0
